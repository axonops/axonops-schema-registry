# Docker Compose for BDD KMS encryption tests.
# Spins up HashiCorp Vault and OpenBao in dev mode with Transit secrets engines
# enabled and a test encryption key pre-created via the setup-kms init service.
# The schema registry runs in-process (httptest); only KMS services run in Docker.
# Usage:
#   docker compose -f docker-compose.kms.yml up -d --wait

services:
  vault:
    image: hashicorp/vault:1.15
    cap_add:
      - IPC_LOCK
    environment:
      VAULT_DEV_ROOT_TOKEN_ID: test-root-token
      VAULT_DEV_LISTEN_ADDRESS: "0.0.0.0:8200"
    ports:
      - "${VAULT_PORT:-18200}:8200"
    healthcheck:
      test: ["CMD", "sh", "-c", "VAULT_ADDR=http://127.0.0.1:8200 vault status"]
      interval: 5s
      timeout: 3s
      retries: 10

  openbao:
    image: openbao/openbao:2.1.1
    cap_add:
      - IPC_LOCK
    environment:
      BAO_DEV_ROOT_TOKEN_ID: test-bao-token
      BAO_DEV_LISTEN_ADDRESS: "0.0.0.0:8200"
    ports:
      - "${BAO_PORT:-18201}:8200"
    healthcheck:
      test: ["CMD", "sh", "-c", "BAO_ADDR=http://127.0.0.1:8200 bao status"]
      interval: 5s
      timeout: 3s
      retries: 10

  setup-kms:
    image: hashicorp/vault:1.15
    depends_on:
      vault:
        condition: service_healthy
      openbao:
        condition: service_healthy
    restart: "no"
    entrypoint: /bin/sh
    command:
      - -c
      - |
        set -e
        echo "Enabling Transit engine on Vault..."
        export VAULT_ADDR=http://vault:8200
        export VAULT_TOKEN=test-root-token
        vault secrets enable transit
        vault write -f transit/keys/test-key
        echo "Vault Transit engine ready."

        echo "Enabling Transit engine on OpenBao..."
        export VAULT_ADDR=http://openbao:8200
        export VAULT_TOKEN=test-bao-token
        vault secrets enable transit
        vault write -f transit/keys/test-key
        echo "OpenBao Transit engine ready."
